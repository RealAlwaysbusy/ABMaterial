var ABMCanvas=function(e,a,t,r){function n(a){var t=e.getBoundingClientRect();L=(a.clientX-t.left)*(e.width/t.width),E=(a.clientY-t.top)*(e.height/t.height),c(L,E,a)}function s(a){var t=e.getBoundingClientRect();L=(a.touches[0].clientX-t.left)*(e.width/t.width),E=(a.touches[0].clientY-t.top)*(e.height/t.height),c(L,E,a)}function c(a,t,r){var i;for(B=!1,i=0;i<m;i++)h(p[i],a,t)?(x=!0,w=i,y=p[i].type):v(p[i],a,t)&&(B=!0,I=i);return x?(p.push(p.splice(w,1)[0]),C=a-p[m-1].x,_=t-p[m-1].y,T=a-C,R=t-_,j=setInterval(o,1e3/30),b4j_raiseEvent("page_parseevent",{eventname:p[m-1].canvasid+"_objectdown",eventparams:"objectid",objectid:p[m-1].id})):m>0&&!B&&b4j_raiseEvent("page_parseevent",{eventname:p[m-1].canvasid+"_canvasdown",eventparams:"x,y",x:parseInt(a,10),y:parseInt(t,10)}),e.removeEventListener("mousedown",n,!1),e.removeEventListener("touchstart",s,!1),window.addEventListener("mouseup",d,!1),window.addEventListener("touchend",d,!1),r.preventDefault?r.preventDefault():r.returnValue&&(r.returnValue=!1),!1}function o(){p[m-1].x=p[m-1].x+S*(T-p[m-1].x),p[m-1].y=p[m-1].y+S*(R-p[m-1].y),!x&&Math.abs(p[m-1].x-T)<.1&&Math.abs(p[m-1].y-R)<.1&&(p[m-1].x=T,p[m-1].y=R,clearInterval(j)),u()}function d(a){e.addEventListener("mousedown",n,!1),e.addEventListener("touchstart",s,!1),window.removeEventListener("mouseup",d,!1),window.removeEventListener("touchend",d,!1),x?(x=!1,b4j_raiseEvent("page_parseevent",{eventname:p[m-1].canvasid+"_objectup",eventparams:"objectid",objectid:p[m-1].id})):m>0&&(B?(b4j_raiseEvent("page_parseevent",{eventname:p[I].canvasid+"_objectclicked",eventparams:"objectid",objectid:p[I].id}),B=!1):b4j_raiseEvent("page_parseevent",{eventname:p[m-1].canvasid+"_canvasup",eventparams:"x,y",x:parseInt(L,10),y:parseInt(E,10)}))}function l(a){var t=e.getBoundingClientRect();L=(a.clientX-t.left)*(e.width/t.width),E=(a.clientY-t.top)*(e.height/t.height),b(L,E)}function g(a){var t=e.getBoundingClientRect();L=(a.touches[0].clientX-t.left)*(e.width/t.width),E=(a.touches[0].clientY-t.top)*(e.height/t.height),b(L,E)}function b(a,t){var r=!1;for(i=0;i<m;i++){if(h(p[i],a,t)){e.style.cursor="pointer",r=!0;break}if(v(p[i],a,t)){e.style.cursor="pointer",r=!0;break}}if(r||(e.style.cursor="default"),x){var n,s,c,o,d,l,g;if(0==y?(o=0,d=e.width-p[m-1].width,l=0,g=e.height-p[m-1].height):(o=c=p[m-1].rad,d=e.width-c,l=c,g=e.height-c),n=a-C,n=n<o?o:n>d?d:n,s=t-_,s=s<l?l:s>g?g:s,p[m-1].draggableW>0){var b=p[m-1].draggableL,u=p[m-1].draggableT,k=b+p[m-1].draggableW,f=u+p[m-1].draggableH;n=n<b?b:n>k?k:n,s=s<u?u:s>f?f:s}T=n,R=s}}function h(e,a,t){if(e.draggable){if(0==e.type)return a>e.x&&a<e.x+e.width&&t>e.y&&t<e.y+e.height;var r=a-e.x,i=t-e.y;return r*r+i*i<e.rad*e.rad}return!1}function v(e,a,t){if(e.clickable){if(0==e.type)return a>e.x&&a<e.x+e.width&&t>e.y&&t<e.y+e.height;var r=a-e.x,i=t-e.y;return r*r+i*i<e.rad*e.rad}return!1}function u(){a.setTransform(1,0,0,1,0,0),"transparent"==t?a.clearRect(0,0,k,f):(a.fillStyle=t,a.fillRect(0,0,k,f));var e;for(m=p.length,e=0;e<m;e++)for(var r=p[e],i=r.x,n=r.y,s=r.commands,c=0;c<s.length;c++){var o=s[c];switch(o[0]){case 1:a.fillStyle=o[1];break;case 2:for(var d=a.createLinearGradient(o[1]+i,o[2]+n,o[3]+i,o[4]+n),l=0;l<o[5].length;l++)d.addColorStop(o[5][l],o[6][l]);a.fillStyle=d;break;case 3:for(var d=a.createRadialGradient(o[1]+i,o[2]+n,o[3],o[4]+i,o[5]+n,o[6]),l=0;l<o[7].length;l++)d.addColorStop(o[7][l],o[8][l]);a.fillStyle=d;break;case 4:a.strokeStyle=o[1];break;case 5:for(var d=a.createLinearGradient(o[1]+i,o[2]+n,o[3]+i,o[4]+n),l=0;l<o[5].length;l++)d.addColorStop(o[5][l],o[6][l]);a.strokeStyle=d;break;case 6:for(var d=a.createRadialGradient(o[1]+i,o[2]+n,o[3],o[4]+i,o[5]+n,o[6]),l=0;l<o[7].length;l++)d.addColorStop(o[7][l],o[8][l]);a.strokeStyle=d;break;case 7:content.shadowBlur=o[1];break;case 8:content.shadowColor=o[1];break;case 9:a.shadowOffsetX=o[1];break;case 10:a.shadowOffsetY=o[1];break;case 11:a.lineCap=o[1];break;case 12:a.lineJoin=o[1];break;case 13:a.lineWidth=o[1];break;case 14:a.miterLimit=o[1];break;case 15:a.rect(o[1]+i,o[2]+n,o[3],o[4]);break;case 16:a.fillRect(o[1]+i,o[2]+n,o[3],o[4]);break;case 17:a.strokeRect(o[1]+i,o[2]+n,o[3],o[4]);break;case 18:a.clearRect(o[1]+i,o[2]+n,o[3],o[4]);break;case 19:a.fill();break;case 20:a.stroke();break;case 21:a.beginPath();break;case 22:a.moveTo(o[1]+i,o[2]+n);break;case 23:a.closePath();break;case 24:a.lineTo(o[1]+i,o[2]+n);break;case 25:a.clip();break;case 26:a.quadraticCurveTo(o[1]+i,o[2]+n,o[3]+i,o[4]+n);break;case 27:a.bezierCurveTo(o[1]+i,o[2]+n,o[3]+i,o[4]+n,o[5]+i,o[6]+n);break;case 28:a.arc(o[1]+i,o[2]+n,o[3],o[4],o[5]);break;case 29:a.arcTo(o[1]+i,o[2]+n,o[3]+i,o[4]+n,o[5]);break;case 30:a.scale(o[1],o[2]);break;case 31:a.rotate(o[1]);break;case 32:a.translate(o[1],o[2]);break;case 33:a.transform(o[1],o[2],o[3],o[4],o[5],o[6]);break;case 34:a.setTransform(o[1],o[2],o[3],o[4],o[5],o[6]);break;case 35:a.font=o[1];break;case 36:a.textAlign=o[1];break;case 37:a.textBaseline=o[1];break;case 38:a.fillText(o[1],o[2]+i,o[3]+n,o[4]);break;case 39:a.strokeText(o[1],o[2]+i,o[3]+n,o[4]);break;case 40:images[o[1]]?images[o[1]].complete&&a.drawImage(images[o[1]],o[2]+i,o[3]+n):console.log("image '"+o[1]+"' must be loaded in BuildPage()!");break;case 41:images[o[1]]?images[o[1]].complete&&a.drawImage(images[o[1]],o[2]+i,o[3]+n,o[4],o[5]):console.log("image '"+o[1]+"' must be loaded in BuildPage()!");break;case 42:images[o[1]]?images[o[1]].complete&&a.drawImage(images[o[1]],o[2],o[3],o[4],o[5],o[6]+i,o[7]+n,o[8],o[9]):console.log("image '"+o[1]+"' must be loaded in BuildPage()!");break;case 43:a.globalAlpha=o[1];break;case 44:a.globalCompositeOperation=o[1];break;case 45:a.save();break;case 46:a.restore();break;case 47:a.arc(o[1]+i,o[2]+n,o[3],o[4],o[5],o[6])}}}this.context=a,this.theCanvas=e;var t=t,k=e.width,f=e.height;m=0,S=.45,p=[],e.addEventListener("mousedown",n,!1),e.addEventListener("touchstart",s,!1),window.addEventListener("mousemove",l,!1),e.addEventListener("touchmove",g,!1);var m,p,w,y,x,L,E,C,_,j,T,R,S,B=!1,I=-1;this.updatecanvas=function(e,a){for(var t=0;t<e.length;t++){var r,n=e[t];switch(n[0]){case"0":r=0==n[2]?{type:0,id:n[1],x:n[5],y:n[6],width:n[7],height:n[8],draggable:n[10],draggableL:n[11],draggableT:n[12],draggableW:n[13],draggableH:n[14],clickable:n[15],commands:n[16],canvasid:n[17]}:{type:1,id:n[1],x:n[5],y:n[6],rad:n[9],draggable:n[10],draggableL:n[11],draggableT:n[12],draggableW:n[13],draggableH:n[14],clickable:n[15],commands:n[16],canvasid:n[17]},p.push(r),m=p.length;break;case"1":for(i=0;i<m;i++)if(p[i].id==n[1]){n[3]&&(p[i].x=n[5]),n[4]&&(p[i].y=n[6]),p[i].commands=n[16];break}break;case"2":for(i=0;i<m;i++)if(p[i].id==n[1]){p.splice(i,1);break}m=p.length}a&&u()}},this.getposition=function(e){var a;for(a=0;a<m;a++)if(p[a].id==e)return p[a].x+";"+p[a].y;return""},this.drawcanvas=function(){u()}};